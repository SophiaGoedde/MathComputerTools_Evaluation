---
title: "Understanding and predicting relationships of lizards and their preferred habitats within the context of habitat conservation and citizen science"
format: pdf
editor: visual
echo: false
---

```{r}
#libraries needed
library(tidyverse) 
library(corrplot) # For correlation plots
library(FactoMineR) # For PCA
library(factoextra) # For PCA plots
library(vegan) # For CCA
library(GGally) #for multiple scatterplots (function ggpairs)
library(rsample) # For sampling of data (split, analysis,..)
library(rpart)
library(rpart.plot)
library(randomForest)
library(caret)
library(class) # For k-NN (function knn)
library(rsample) # For resampling (split, analysis,..)
library(caret)

library(themis) 
library(permute)
library(recipes)

library(ggplot2)
library(ggrepel)
```

## Introduction

As lizard populations face extinction pressures around the globe due to climate and land-use change (Cosendey et al, 2022, Jiang et al, 2023), habitat protection and restoration is a primary strategy for lizard conservation. Knowing which habitat types are associated with a given lizard is needed for this conservation method to be successful. 

Lizards show a wide ecological and morphological diversity, with species occupying habitats ranging from saxicolous areas, aquatic habitats to forests and terrestrial habitats  (Pianka & Vitt 2003). Differentiation across the landscape of resource availability, predation risk, and microhabitat complexity create different habitat types that may be selected for a specie’s size and thermal constraints (Pianka & Vitt 2003).  Therefore, morphological traits representing these constraints and selection pressures are often related to specific habitat specializations (Munoz & Losos 2018). A lizard’s body size, often measured as snout–vent length (SVL), is an important trait since it influences motion, thermal regulation and buffering and microhabitat use (Munoz & Losos 2018, Meiri 2008). 

Broad-scale environmental variation that influences thermal landscapes, seasonal activity, and the availability of habitat types is captured by latitude (Buckley et al. 2010). Additionally, if a converse Bergmann’s rule applies to lizards, where larger-bodied species occur in warmer regions or at lower latitudes, then body size (SVL) should show predictable geographic trends. Several studies support this expectation. Ashton et al. (2003) found that 61 of 83 species decreased in size with increasing latitude. In the Sceloporus genus, an analysis of 106 species and populations revealed that body size increases with higher maximum temperatures and greater aridity (Oufiero et al. 2011), with similar results reported in China (Liang et al. 2021).  However, other work has documented opposing trends ( Olalla-Tárraga et al. 2006). 

Both SVL and latitude are simple field measurements to observe and could offer a practical way to predict further ecological traits, such as preferred habitat. This is particularly useful for species where detailed natural-history data are scarce or missing as it is the case in many datasets (Pincheira-Donoso et al. 2011; Lambert et al. 2012). For many incidental encounters, such as opportunistic captures, road-crossings, or photos, SVL and coordinates may be the only consistent measurements available. The practicality of minimal measurements also extends to the growing contribution of citizen science. Species-identification apps and photo platforms increasingly provide georeferenced observations, and some can estimate body size from images. If these basic descriptors can reliably predict a species’ preferred habitat, researchers could infer habitat associations even for sparsely documented taxa, anticipate where additional individuals may be found, and refine ecological niche models (Anderson 2003; Poe et al. 2017) which has the potential to inform habitat protection and species-monitoring strategies.

Conservation may be linked to a whole lizard family instead of an individual species, thus there is also a need to understand if families are related to particular habitats (ie. by conserving y habitats can you protect all species within the x family). Lizard families often show similar tendencies due to phylogenetic similarities in behaviour (such as e.g. foraging mode). Moreover, understanding which families are linked to particular habitat types, can help to anticipate which evolutionary lineages are most vulnerable to land-use and climate change when these habitat types are threatened (Buckley et al. 2010). Habitat-specific families may face a disproportionate risk if their preferred environments disappear or change, while generalist families may be more resilient.

In the context of habitat conservation for lizards using citizen science, and thus few variables, we asked the following questions: (Q1) Can female SVL and latitude accurately predict a lizard’s preferred habitat type? and (Q2) Do preferred habitat types correspond to lizard families?

It was hypothesised that (H1) preferred habitat can be predicted from SVL and latitude because of known trends such as the Bergmann’s rule and demonstrated morphological trait relationships to specialized habitats (Liang et al. 2021, Oufiero et al. 2011, Munoz & Losos 2018, Meiri 2008).

It was also hypothesised that (H2a) there is a correlation between habitat and lizard family. It is further predicted that (H2b) a family’s distribution, range, and predominant foraging strategy can explain their relationship with preferred habitat. \<sentence with citation to support these variables used Kate!\>

The relationships studied in these questions provide a framework for interpreting how morphological traits (SVL), geographic constraints (latitude), and family lineages interact to determine which species may decline under future environmental change and which habitats require priority protection.

## Materials and Methods

To analyze our questions we have access to a global database of lizard populations and their traits which includes quantitative data: Mean Female SVL, Mean Female body weight, Female SVL at maturity, Offspring SVL, clutch size, RCM (relative clutch mass); and qualitative data: distribution (tropical/temperate), foraging mode (active/sit and wait), preferred habitat type; additionally latitude and longitude and family and genus are included for observations of each population (Mesquita 2015). All analyses were conducted in R (Version 2025.09.1+401). 

### Predicting preferred habitat

To test whether morphological traits (Mean Female SVL and Latitude) can be used to predict habitat type of lizard populations, KNN and random forest models were used and compared. SVL and latitude were selected because of their easy observation in the field and having very few missing values in the data set (number of observations used: 689). Additionally, preliminary correlation checks, exploratory plots, and PCA showed these variables were not strongly correlated but also suggested weak associations between SVL, latitude, and habitat, which already indicated a limited predictive potential (figure: coorplot, scatterplot). Other ecological predictors were not considered due to many missing values and their higher difficulty to obtain these information in the field. The dataset was filtered to retain the key predictor variables and populations with missing values were removed. The main goal was to find the best predictive model of a lizard's habitat Type as a function of Mean Female SVL and Latitude. Habitat type was converted to a factor, and the data were randomly split into an 80–20 training–test set using initial_split(), stratified by habitat class.

```{r}
#| label: Data exploration
#| include: false
# Load dataset
lizard2 <- read.csv("lizard2.csv")

# rename columns 
names(lizard2) <- c(
  "Species",
  "Genus",
  "Family",
  "Population",
  "Longitude",
  "Latitude",
  "AFWeight",              # Average Female adult weight (g)
  "SDFAWeight",              # SD Female adult weight (g)
  "SampleFAWeight",          # Sample Size Female adult weight
  "MeanFSVL",                # Mean Female SVL adults (mm)
  "SDFSVL",               # Standard deviation Female SVL adults (mm)
  "SampleFSVL",              # Sample size Mean Female SVL adults
  "FSVL_mature",          # Female SVL at maturity (mm)
  "OffspringSVL",         # Offspring SVL (mm)
  "MeanClutch",              # Mean Clutch Size
  "SampleClutch",            # Sample size for Clutch Size
  "ReproductionMode",        # Mode of reproduction
  "ClutchesPerYear",         
  "ClutchFreq",              # Clutch Frequency
  "RCM",                     
  "ForagingMode",           
  "Distribution",            
  "Habitat_Type",            
  "Source"                   
)

# Select relevant columns & remove na
sublizard <- lizard2 %>%
  select(Habitat_Type, Latitude, MeanFSVL) %>%
  drop_na()
# From 740 to 686 observations 

# summary and check dataset (especially concerning continous and categorical variables)
summary(sublizard)

#Change habitat type to numercial values (1-8)
sublizard$Habitat_Type = as.factor(sublizard$Habitat_Type)

# Random splitting of test and training data randomly (80-20%) with rsample package 
split <- initial_split(sublizard, prop = 0.8)
train_set <- analysis(split)
dim(train_set); head(train_set)

test_set <- assessment(split)
dim(test_set); head(test_set)


#####Data exploration###### not included in final report

# Checking Data: Boxplot for relationship between mean female SVL and Habitat Type. Same is done for 
boxplot(MeanFSVL ~ Habitat_Type, data = lizard2,
        main = "SVL Mean by Habitat Type", xlab = "Habitat Type", ylab = "Mean Female SVL ")

boxplot(Latitude ~ Habitat_Type, data = lizard2,
        main = "Latitude by Habitat Type", xlab = "Habitat Type", ylab = "Latitude")
# for a few habitat types a clear difference can be seen 

#Distribution - Pairs plot with correlation
GGally::ggpairs(sublizard, aes(color = Habitat_Type))

# Visualization: SVL & Latitude -> Habitat Type
# habitat ~ SVL
ggplot(sublizard, aes(x = Lati, y = MeanFSVL, fill = Habitat_Type)) +
  geom_boxplot() + theme_bw()
# # It does not seem like SVL has an impact on habitat type - similar distributed. 

# habitat ~ latitude 
ggplot(sublizard, aes(x = Habitat_Type, y = Latitude, fill = Habitat_Type)) +
  geom_boxplot() + theme_bw()

#/need to match Kate's data name -or just remove
#initial dataframe exploration
# str(liz)
# 
# n_distinct(liz$Prefered.Habitat.Type)
# unique(liz$Prefered.Habitat.Type)
# 
# unique(liz$Family)
# n_distinct(liz$Family)
# 
# liz %>%
#   group_by(Prefered.Habitat.Type) %>%
#   summarise(n=n())
# liz %>%
#   group_by(Family) %>%
#   summarise(n=n())

#checking for correlation of variables (in small dataset, minmized by nas)
#/ find duplicates with above and what want to include and dataframe setup needed for that output

#balloon correlation matrix
# liz.scaled %>% # In data_soils
#   select_if(is.numeric) %>% # Select only numeric columns
#   cor() %>% # Calculate the empirical correlation matrix
#   corrplot() # Then graph this matrix
# 
# #correlation plot
# liz.var2 =select(liz.var, - c(Mode.of.reproduction, Clutches.per.year, Clutch.Frequency))
# ggpairs(liz.var2, columns = 5:11)
# 
# #pca and plot
# result_pca <- PCA(liz.scaled, 
#                scale.unit = TRUE, 
#                graph = F)
# fviz_eig(result_pca, choice = "variance") ####need to choose how many dimensions look at
# result_pca$var$contrib
# 
# fviz_pca_var(result_pca, axes = c(1, 2), col.var="cos2") # axes 1 &2 
# fviz_pca_var(result_pca, axes = c(1, 3), col.var="cos2") #axes 1&3
# #with population points and by habitat type
# fviz_pca_biplot(result_pca, axes = c(1,2), col.ind=liz.var$Prefered.Habitat.Type)
```

```{r}
#| label: Figure 1
#| echo: false
#| message: false
#| warning: false
#| fig-height: 3
#| fig-width: 4

#scatterplot of data
# Plot data 
ggplot(sublizard) +
aes(x = MeanFSVL, y = Latitude, color = Habitat_Type) +
geom_point() +
labs(x='Mean SVL'
,y='Latitude')
#INTERPRETATION 
#Pattern Terrestrial accumulation around -5 ; -25 and 25. 
# Saxicolous: accumulation at -10 and 15. 
```

#### KNN

KNN method was used because a newly found lizard could be classified to a specific habitat type only by the majority vote of its nearest neighbours. With potential citizen science adding constantly new data samples, the algorithm can quickly be adjusted. Habitat type was encoded as 8 factor levels (one per habitat category) and the dataset was randomly split into 80% training and 20% testing subsets. The optimal number of neighbours (k) was selected through 10-fold cross-validation using caret::train() with centering and scaling applied to the predictors and performance of the predictions was assessed using a confusion matrix. A prediction grid was created to visualize the predicted habitat type across latitude and SVL values. An uncertainty grid, displaying the frequency of neighbors not belonging to the predicted class among all the neighbors, was used to visualize the uncertainty of the predictions made.

```{r}
#| label: KNN
#| message: false
#| warning: false
#| include: false
### KNN ###########
set.seed(123)

### Cross validation for choice of k
# Defining how many folds (10 folds means splitting dataset into 10 equal parts. The model is trained on 9 parts and tested on the remaining 1, this is repeated 10 times (every time with a different fold). 
ctrl <- trainControl(method = "cv", verboseIter = FALSE, number = 10) 

# knn fit with centering and scaling all numeric variables for distance calculations
knnFit <- train(Habitat_Type~.,
                data = train_set,
                method = "knn",
                trControl = ctrl ,
                preProcess = c("center", "scale"),
                tuneGrid = expand.grid(k = 1:50))
plot(knnFit)
# Plot shows development of accuracy according to the number of neighbours chosen (train dataset contains 10% of all data)

### CV accuracy if highest for which k
k_best <- knnFit$bestTune$k
k_best
#This best k value changes all the time depending on test and train data (randomly distributed)
# Best k: 20

### Now running KNN with best k fit of the train set
best_knn <- knn(train = select(train_set,-Habitat_Type),
                test = select(test_set,-Habitat_Type),
                cl = train_set$Habitat_Type,
                k = k_best,
                prob = TRUE)
best_confusion_matrix <- table(Predicted = best_knn,
                               True = test_set$Habitat_Type) 
best_confusion_matrix
# Now the confusion matrix shows a bit better results. The habitat types Saxicolous and Aboreal were, additional to 48 correct predictions for Terrestrial, two times each correctly predicted. However, the terrestrial habitat type was 5 times falsy positive predicted compared to initial training. 
accuracy_best <- sum(diag(best_confusion_matrix)) / sum(best_confusion_matrix)
accuracy_best
# 0.5652174

### Plotting the results
# Predict zone of influence for each class –> define a prediction grid
# To know the range check data raneg of SVL and Latitude first
range(sublizard$MeanFSVL)
# 21.397 312.100
range(sublizard$Latitude)
# 0.29 51.35

# Prediction grid with min and max values of predictors
grid_prediction <- expand.grid(
  MeanFSVL = seq(min(sublizard$MeanFSVL), max(sublizard$MeanFSVL), length.out = 200),
  Latitude = seq(min(sublizard$Latitude), max(sublizard$Latitude), length.out = 200)
)
grid_prediction

### Predcition grid for the chosen k (20) 
# using all data (reunite train and test data
predicted_Habitat <- knn(train = select(CSVLH_lizard,-Habitat_Type), 
test = grid_prediction, 
k = k_best, 
cl = CSVLH_lizard$Habitat_Type, 
prob = TRUE) 
# Prob=TRUE for the uncertainty associated with estimation (coded as attribute of prediction vector) # This attribute now has to be extracted 
proba_Habitat <- attr(predicted_Habitat, "prob")
proba_Habitat
# Final-result in table 
final_predictions <- grid_prediction %>%
mutate(Habitat_Type = predicted_Habitat,
Probability = proba_Habitat)
summary(final_predictions)
final_predictions
# INTERPRETATION: only the first three habitats were predicted (Terretrial 38600 times, Aboreal 903 times and Saxicolous 497 times). 

# mean predictions per class 
class(final_predictions)
str(final_predictions)
head(final_predictions)

```

#### **Random Forest**

To improve habitat classification with SVL and Latitude, a random forest model was applied using the same dataset and predictor variables. Random forest models are non-linear methods for supervised classification with several prediction trees. Additionally, Random forest models can simultaneously  consider qualitative and quantitative variables, which was necessary in our case and due to its easily interpretable logical classification rules. The dataset was split into 80% training and 20% testing  and parameters for pruning were fixed/set by default. Initial exploratory models using the dataset revealed that classification accuracy was strongly biased toward the dominant class (“Terrestrial”) (table of totals by habitat).  Random Forest hyperparameters were tuned using repeated 10-fold cross-validation (10 folds × 5 repeats) with a grid search over mtry = 1–2 (caret library), reflecting the two predictor variables. The optimal RF model (500 trees, mtry = 1) was then fitted to the training set. 

To evaluate and mitigate this class imbalance problem, three strategies were implemented: A class-weighted random forest, where class weights were calculated as the inverse of habitat class frequency so rare categories received greater influence in the model. Secondly, a downsampled random forest, where the majority class (Terrestrial) was reduced to match minority class sizes, which, however, reduced the sample size too drastically. Thirdly, the minority classes were upsampled to match the terrestrial majority class.

```{r}
#| label: RF
#| message: false
#| warning: false
#| include: false
### Splitting dataset into train and test data the same way as KNN 
# Why: To compare the results and the show the robustness of algorithm and to later compare results of accuracy with KNN. 
train_RF_lizard <- train_set
test_RF_lizard  <- test_set

#### Choosing hyperparameters with cross-validation 
parameters_CV_lizard <- trainControl(method = "repeatedcv",
                          number = 10,
                          repeats = 5)
# For all the available methods (and the necessary arguments), please refer to help.
rf_grid <- expand.grid(mtry = 1:2) # because 2 variables 

predictor_forest <- caret::train(Habitat_Type ~., 
                                 data = train_RF_lizard, 
                                 method = "rf", 
                                 metric = "Accuracy",
                                 trControl = parameters_CV_lizard, 
                                 tuneGrid = rf_grid,
                                 ntree = 500)
predictor_forest 
# chosen mtry was 1 

# Visualize cross-validation results of mtry 
as.data.frame(predictor_forest$results) %>%
ggplot(aes(x = mtry, y = Accuracy)) +
geom_point()

# Aggregate performance results into an object to use later 
my_predictions <- predict(predictor_forest, newdata = select(test_RF_lizard,- Habitat_Type))
my_predictions

# Contingence table
table(prediction = my_predictions, truth = test_RF_lizard$Habitat_Type)


########### RF with normal/baseline dataset #################
forest_lizard_base <- randomForest(
  Habitat_Type ~.,
  data = train_RF_lizard, 
  ntree = 500,
  maxnodes = 10,
  mtry = 1,
  importance = TRUE)

# Predictions
rf_pred_base <- predict(
  forest_lizard_base,
  newdata = select(test_RF_lizard, -Habitat_Type))

# Accuracy
acc_base <- predict(forest_lizard, newdata = select(test_RF_lizard,- Habitat_Type)) %>% 
  table(prediction = ., truth = test_RF_lizard$Habitat_Type) %>%
  {sum(diag(.)) / sum(.)}
#0.6043165

# Look at Confusion Matrix 
conf_base <- table(prediction = rf_pred_base,
                       truth = test_RF_lizard$Habitat_Type)
conf_base
# A few rare habitats were correctly predicted:
# Arboreal: 6 correct & Saxicolous: 1 correct
# This is already better than KNN, which predicted 0 for all rare habitats but still very weak. Therefore weighnted class 

### Chechking variable importance 
varImpPlot(forest_lizard)
# Latitude more important in predicting Habitat Type than Mean SVL. 


################ RF with weighted classes ###################
# Loosing data from terrestrial class to match closer with rare habitats. Downside: loosing a lot of data and since small groups are VERY small this might lead to even more inaccuracy. Upsampling of rare classed could lead to over-fitting. 

# Calculate class weights (inverse frequency → more weight to rare habitats)
class_weights <- 1 / table(train_RF_lizard$Habitat_Type)
class_weights <- class_weights / sum(class_weights)

# RF with weightened classes 
forest_lizard_weighted <- randomForest(
  Habitat_Type ~ .,
  data = train_RF_lizard,
  ntree = 500,
  mtry = 1,
  importance = TRUE,
  classwt = class_weights)


# Predictions
rf_pred_weighted <- predict(
  forest_lizard_weighted,
  newdata = select(test_RF_lizard, -Habitat_Type))

# Accuracy 
acc_weighted <- predict(forest_lizard_weighted, newdata = select(test_RF_lizard,- Habitat_Type)) %>%
table(prediction = ., truth = test_RF_lizard$Habitat_Type) %>%
  {sum(diag(.)) / sum(.)}
acc_weighted
# 0.5539568

# Look at Confusion Matrix 
conf_weighted <- table(prediction = rf_pred_weighted,
                       truth = test_RF_lizard$Habitat_Type)
conf_weighted
# A bit better but still strong bias towards terrestrial. 
# correctly predicts more Arboreal and Saxicolous individuals (7 and 8 true positives, respectively, vs. 6 and 1 in base prediction). 
# but still many habitat types undetected. 
# Aquatic, Bromelicolous, Fossorial, Psammophilus, and Semi-arboreal have zero true positives

####################### RF by downsampling #######################
# Downsample the training data by reducing terrestrial class
train_down <- downSample(
  x = select(train_RF_lizard, -Habitat_Type),
  y = train_RF_lizard$Habitat_Type,
  yname = "Habitat_Type")
# Already not good since all classes end up with only 2 samples
# cannot be used! 

table(train_down$Habitat_Type)
# now all have only 2 observations - very likely that this is too few! 
# Upsampling might be a better solution with this dataset. 

# RF with downsampled data 
forest_lizard_down <- randomForest(
  Habitat_Type ~ .,
  data = train_down,
  ntree = 500,
  mtry = 1,
  importance = TRUE
)

# Predictions on original test set
rf_pred_down <- predict(forest_lizard_down,
                        newdata = select(test_RF_lizard, -Habitat_Type))
rf_pred_down
# Confusion matrix
conf_down <- table(prediction = rf_pred_down,
                   truth = test_RF_lizard$Habitat_Type)
conf_down
# True positives: Arboreal: 6 ; Saxicolous: 3 ; Fossorial: 1 ; Semi-arboreal: 1 ; Psammophilus: 1 ; Aquatic: 3 ; Bromelicolous: 0 (still too rare)
# But more missclassification bcs 90% of dataset (terrestrial) was removed to match the samll sampled
# Therefore: overfitting to the downsampled minority classes.

# Accuracy
acc_down <- sum(diag(conf_down)) / sum(conf_down)
acc_down
# 0.1870504
# Very low accuracy. So more rare habitats were predicted but many of them might be falsly predicted. 



########################### RF by upsampling #######################
# Upsample the training data by duplicating minority classes
train_up <- upSample(
  x = select(train_RF_lizard, -Habitat_Type),
  y = train_RF_lizard$Habitat_Type,
  yname = "Habitat_Type")

table(train_up$Habitat_Type)
# Now all have 332 observations. 

# RF on upsampled data
forest_lizard_up <- randomForest(
  Habitat_Type ~ .,
  data = train_up,
  ntree = 500,
  mtry = 1,
  importance = TRUE)

# Predictions on original test set
rf_pred_up <- predict(forest_lizard_up,
                      newdata = select(test_RF_lizard, -Habitat_Type))

# Confusion matrix
conf_up <- table(prediction = rf_pred_up,
                 truth = test_RF_lizard$Habitat_Type)
conf_up

# Accuracy
acc_up <- sum(diag(conf_up)) / sum(conf_up)
acc_up
# 0.5107914


############## comparison of RF methods ############
# Comparison of all 4 Random Forest models
rf_comparison <- data.frame(
  Model = c("Baseline RF", "Class-Weighted RF", "Downsampled RF", "Upsampled RF"),
  Accuracy = c(acc_base, acc_weighted, acc_down, acc_up))
rf_comparison

# Visualize results 
ggplot(rf_comparison, aes(x = Model, y = Accuracy, fill = Model)) +
  geom_col() +
  theme_minimal() +
  coord_flip() +
  labs(title = "Comparison of Random Forest Models",
       y = "Accuracy",
       x = "")
# Baseline RF achieved highest accuracy but its because its bias towrads terrestrial class and no detection of rare classes.
```

#### Model comparison

To compare the performance of KNN and RF, a final KNN model was fitted using the best k and evaluated on the same RF test set. Model performance for both methods was assessed using confusion matrices, overall accuracy, Cohen’s Kappa, and balanced accuracy to account for strong class imbalance.

```{r}
#| label: Model comparison
#| message: false
#| warning: false
#| include: false
## Comparison: KNN & RF
cm_knn_RF <- confusionMatrix(
  data      = best_knn_RF,
  reference = y_test_RF)

cm_rf_RF <- confusionMatrix(
  data      = rf_pred_RF,
  reference = y_test_RF)

# get mean balanced accuracy across classes
balacc <- function(cm) {
  mean(cm$byClass[, "Balanced Accuracy"], na.rm = TRUE)}

results_compare <- data.frame(
  Model            = c("KNN", "Random Forest"),
  Accuracy         = c(cm_knn_RF$overall["Accuracy"],
                       cm_rf_RF$overall["Accuracy"]),
  Kappa            = c(cm_knn_RF$overall["Kappa"],
                       cm_rf_RF$overall["Kappa"]),
  BalancedAccuracy = c(balacc(cm_knn_RF),
                       balacc(cm_rf_RF)))

results_compare
```

### **Habitat type and family**

The dataset was transformed to an abundance matrix of preferred habitat type and families once missing values were removed and only for families that were represented by more than 20 populations (n=12, total observations used: ) (table of data). This filter was implemented so that there were enough observations to analyse relationships for the family. For each of these families, range from minimum to maximum latitude, proportion of populations with active foraging methods, and proportion located in the tropics was calculated to describe family characteristics. Other quantitative variables were difficult to summarise and still fully represent diversity within a family, thus were chosen not to be used in this analysis. Proportion of active foraging is low when a ‘sit and wait’ strategy is more common, the same is true for low proportion of tropical distribution reflecting high amounts of temperate distribution. Foraging mode is a population’s strategy that may be closely tied to their prey and thus their habitat. \<example cite?\> Latitude range was used instead of minimum and maximum latitude (or absolute latitude) as it was theorized families with a larger range would have access to more habitat types across their range, this value does not represent if the family is evenly distributed across this range. 

```{r}
#| label: CCA data set up
#| include: false
#data read in 
#/ should be able to do this once for both analysis, just need to change names
liz = read.csv("lizard.csv", header=T)
liz = filter(liz, Genus != "")

# dataframe setup for ca &cca
aliz=liz %>%
  group_by(Prefered.Habitat.Type, Family) %>%
  summarise(n=n()) %>% 
  filter(Prefered.Habitat.Type != "")
aliz

#create matrix
mliz = aliz %>% 
  pivot_wider(names_from = "Prefered.Habitat.Type", values_from = n) %>% 
  replace(is.na(.), 0) 

#reduce to families with >20 observations
countFam =liz %>% 
  group_by(Family) %>%
  count() %>% 
  filter(n>20)
Fam = countFam$Family

mlizsm = mliz %>% filter(Family %in% Fam)%>% 
  column_to_rownames("Family")
mlizsm

###create dataframe of summary variables for families
#set Active foraging to 1 and Sit&Wait to 0; set Tropical distribution to 1 and Temperate to 0 (to calculate proportion)
liz = liz %>% 
  mutate(ForageActive = if_else(Foraging.Mode == "Active", 1, 0)) 
liz = liz %>% 
  mutate(DistTropic = if_else(Distribution == "Tropical", 1, 0)) 

fam.var = liz %>%
  filter( Family %in% Fam) %>% 
  group_by(Family) %>%
  summarise(n=n(), minLat= min(Latitude), maxLat = max(Latitude), range= maxLat-minLat, pctActive= sum(ForageActive)/n(), pctTropic= sum(DistTropic)/n())



######### exploration of data #####################
#correlation exploration with heatmap
aliz %>% 
  filter( Family %in% Fam)%>%
  ggplot() +
  aes(x = Prefered.Habitat.Type, y = Family, fill = n) + 
  geom_raster() + 
  scale_fill_viridis_c() + # Change color scale
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

```{r}
#| label: Table 1
#| echo: false
mlizsm
#/ should add column and row totals
```

General correlations among and between habitats and families were observed using general correspondence analysis. Canonical correspondence analysis (vegan package) was run using the covariables of lizard families to explain preferred habitat types. Eigen values were used to determine the amount of inertial explained by this model and an ANOVA was used to test for the significant contribution of these covariables.

```{r}
#| label: CCA
#| include: false
########### CCA #########################
#run CCA
CCAresult = cca(mlizsm ~ range + pctActive + pctTropic, data = fam.var)

#extract data
CCAscores = scores(CCAresult)
CCAtable = CCAresult$CCA$u
CCAcorr = cor(CCAtable, fam.var[, c("range", "pctActive", "pctTropic")])
# extract data for graph
CCAscores_species = as.data.frame(CCAscores$species) %>% 
  rownames_to_column(var = "Habitat")
CCAscores_sites = as.data.frame(CCAscores$sites) %>% 
  rownames_to_column(var = "Family")
CCAscores_var = as.data.frame(CCAscores$biplot) %>% 
  mutate_all(function(x)x*ordiArrowMul(CCAscores$biplot)) %>%
  rownames_to_column(var = "Covariable")

#result summary
summary(CCAresult)
## total of 0.9529 inertia, 35% explained by constrained model variables. 

#statistical test of full model
anova(CCAresult)
## p-value = 0.2 so not significant
anova(CCAresult,by="margin") #test of contributions of individual variables
##should not use this because above result is not significant

################## CA #########################

result_CAsm <- CA(mlizsm, graph = T)

fviz_eig(result_CAsm) # support use of first 2 dimentions, since eigen values level out afterwards for further dimentions
summary(result_CAsm)


```

# Results

### **Predicting preferred habitat**

The optimised model (cross-validated best k) predicted nearly all species as terrestrial, the dominant class, with only a handful of saxicolous or arboreal predictions and with no clear habitat structure present on decision surface maps (figure: a-predicted habitat type according to k-nearest neighbor, b-Hbaitat prediction uncertainty). The probability values were low (0.45-0.7) demonstrating uncertain predictions. Accuracy 0.56) appeared high because of extreme class imbalance, as all minority classes were never predicted.  This can be seen in both graphs: most of the landscape of SVL × Latitude was classified as Terrestrial (except a few patches) and uncertainty was almost always over 0.5 (mid to dark red). This may have been due to an unbalanced dataset and therefore a second phase of modeling was incorporated with a random forest model which can handle unbalanced datasets better.

```{r}
#| label: Figure 2
#| echo: false
#| message: false
#| warning: false
### Plotting KNN predictions 
ggplot(final_predictions) +
  aes(x = MeanFSVL, y = Latitude) +
  geom_raster(aes(fill = Habitat_Type), alpha = 0.6) +
  geom_point(data = sublizard, aes(color = Habitat_Type), size = 1.5) +
  labs(
    x = 'Mean SVL',
    y = 'Latitude',
    title = 'KNN-Predicted Habitat Types'
  ) +
  scale_x_continuous(expand = c(0, 0)) +
  scale_y_continuous(expand = c(0, 0))
# INTERPRETATION: The graph shows that almost all predictions are terrestrial which shows for a very unbalanced model due to an extramly unbalanced dataset and potentially too weak predictors too. 


### Present uncertainty with predictors 
# Uncertainty is the frequency of neighbors not belonging to the predicted class among all the neighbors.
ggplot(final_predictions) +
aes(x = MeanFSVL, y = Latitude) +
geom_raster(aes(fill = 1- proba_Habitat)) + # =uncertainty
geom_point(data = sublizard, aes(color = Habitat_Type)) +
labs(x = "Mean Female SVL", y = "Latitude", title = "KNN-Habitat Prediction uncertainty",
fill = "Uncertainty") +
scale_x_continuous(expand = c(0, 0)) +
scale_y_continuous(expand = c(0, 0)) +
scale_fill_gradient(low = "white", high = "darkred")
# INTERPRETATION: The classifier learned nothing about the havitat type. The uncertainry is the same almost everywhere and very high. (mostly over 0.5), which indicated a high uncertainty and therefore a bad prediction. Reasons for this stated below (Class imbalance in dataset and probably too few predictors). 
# The model is biased towards the majority class.
```

Across the four random forest (RF) models, the baseline RF achieved the highest overall accuracy (0.60), but this performance was largely driven by its strong bias toward terrestrial habitat and almost no detection of rare classes. The introduced class weights reduced this majority-class dominance and improved minority-class sensitivity, but the trade-off was a drop in accuracy (0.55). This reflects a more balanced, but less precise classification. In contrast, the downsampled RF performed poorly (0.19) because reducing the size of the dominant class removed most of the information the model needed and caused an overfitting of the model. The upsampled RF, where rare classes were duplicated, offered an intermediate outcome (0.51). This improved the recognition of minority habitats without throwing away data, but still had a problem with a reduced reliability for the dominant class. (figure RF comparison). Checking the variable importance revealed that latitude plays a more important role in predicting Habitat Type compared to mean female SVL.

Compared to the RF models, the KNN classifier performed extremely poorly since it predicted for almost every lizard a terrestrial habitat and failed to identify any rare habitat types. Model performance was broadly similar between KNN and Random Forest when evaluated on the same test set. KNN achieved the highest overall accuracy (0.64), but Random Forest produced higher Kappa values (0.33) and higher balanced accuracy (0.57) which indicates a better performance on minority habitat classes (as seen above). This suggests that while KNN predicted the dominant terrestrial habitat slightly more consistently, Random Forest captured rare habitats more effectively and made minimal more reliable predictions overall. However, both results are not really accurate and good enough to predict habitat types.

### **Habitat type and family**

```{r}
#| label: CCA results
#| message: false
#| warning: false
#| include: false
#plot CCA results
plot(CCAresult)
corrplot(CCAcorr)

fviz_eig(CCAresult)
screeplot(CCAresult, bstick = TRUE, type = c("lines"))

ggplot(CCAscores_sites)+
  aes(x =CCA1, y=CCA2)+
  geom_hline(linetype=2, yintercept = 0)+
  geom_vline(linetype=2, xintercept = 0)+
  #geom_point(aes(color=Family))+
  geom_point(data=CCAscores_species, color ="red")+
  geom_text_repel(data = CCAscores_species, aes(label = Habitat), color= "red")+
  geom_text_repel(data = CCAscores_var, aes(label = Covariable), color="black")+
  geom_segment(data= CCAscores_var, aes(xend = CCA1, yend = CCA2), x =0, y=0, color = "black", arrow = arrow(length = unit(0.1, "cm")))+
  geom_point(data=CCAscores_sites, color ="blue")+
  geom_text_repel(data = CCAscores_sites, aes(label = Family), color= "blue")+
  theme_bw()
```

When variables for lizard families of latitudinal range, percent active foragers, and percent tropically distributed were included in canonical correspondence analysis, 35% of the total inertia (0.95) was explained by these variables. Dimension 1 was weakly negatively correlated to range and dimension 2 was  highly positively correlated to range and negatively to percent tropical (figure correspondence plot?). Percent tropical and percent active are inversely related in these dimensions. However, a high p-value for this overall solution (p=0.225) demonstrates that these variables do not significantly explain the explain the relationship between lizard families and their preferred habitats, thus further testing for the significance of axes relationships are not further examined (lowest p-values for range (0.08) and percent tropical (0.10) axes indicate that these contribute the most to the poorly fit model).

```{r}
#| label: Figure X
#| echo: false
#| fig-height: 3
#| fig-width: 3

plot(result_CAsm)
```

Because canonical correspondence analysis was not able to explain associations well, habitat preferences and family associations are discussed using correspondence analysis results (Fig CA plot). Correspondence analysis showed that the first principle plan represents 68% of the deviations from independence (Dimension 1: 49%, Dimension 2: 19%) and low contributions from later dimensions.  Some families strongly deviate from an average distribution between preferred habitat types, this is particularly true for Xenosauridae, Dactylodae, Gekkonidae, and Tropiduridae. Other families are closer to the average profile of habitat preference.

Distinctive habitats include arboreal and saxicolous. Additionally, semi-arboreal and arboreal are slightly associated, while saxicolous and psammophilus are also associated. There is also a grouping of the remaining habitats: aquatic, terrestrial, fossorial, and bromelicouls. Due to this grouping it is hard to differentiate habitat preferences for Scincidae, Teiidae, and Gynophthalimidae families between these four habitat types. We do observe a strong association of Dactyloidae and Gekkonidae with arboreal habitat preference, while Xenosauridae, Tropiduridae, and Phyllodactylidae with saxicolous or psammophilus habitats.

# Discussion

### **Predicting preferred habitat**

The results both from KNN and RF methods indicate that SVL and latitude are not good enough predictors of a lizards preferred habitat and the hypothesis (H1) can therefore not be supported.   This collapse occurred because KNN is highly sensitive to class imbalance. In contrast, all Random Forest variants, despite their own limitations, were able to detect at least some minority habitats. Two primary factors can explain this: A high class imbalance in the dataset and the amount of limited predictor variables used. 

The first limitation, concerning the imbalanced dataset with terrestrial species overrepresented, leads algorithms like RF but especially KNN to favor the majority class, reducing their ability to detect more rare categories for new data. Different methods were attempted to account for this imbalance which then however faced other trade-offs such as a too small sample size or overfitting of the model. 

Imbalanced representation of ecological data in biodiversity research is also often linked to uneven sampling effort across regions, particularly the strong geographic bias toward accessible sites and countries in the Global North (Meyer et al. 2015; Boakes et al. 2010). This pattern may arise from historical research infrastructures, logistical constraints in remote habitats, and uneven funding distribution. Citizen-science initiatives supported by machine-learning tools can be a future way to reduce global sampling gaps and diversify occurrence records, if they are trained on a globally representative dataset. Furthermore, imbalance of categories could be attributed to the dominance preference for terrestrial habitat between populations or that this habitat classification should be further refined to different terrestrial habitat types. Terrestrial habitat is a common catch-all classification for any species that live on land \[\], when species are generalists as many lizard species are \[\] this classification is accurate, but specialists may be more accurately classified.

The second limitation concerns the predictor variables used. SVL and latitude provide only broad ecological information and cannot capture the multidimensional factors shaping lizard habitat choice. Habitat preference might be more precisely influenced by behavioral traits, microclimate specialization, phylogenetic history, and long-term evolutionary niche adaptation (). Even though the objective was  a habitat prediction for conservation objectives with easily collectable data, one can assume that the more population traits fed into the algorithm, the better ability to accurately predict variables such as habitat preference. When using citizen science to collect more but limited ecological data, it reduces sampling effort drastically so that redundant or unpredictive variables do not need to be collected. However, it is important to see how much one can actually interpret from a sample with such few ecological variables.

Because most lizards are terrestrial and therefore likely to be ecological generalists, they may be less strongly affected by climate- or land-use change. Future studies could examine whether terrestrial species actually occupy broad or highly specific niches to clarify how important this distinction is for habitat conservation.If the model could accurately predict broader environmental habitat tendencies, the literature would suggest that larger lizards (which tend to have lower surface-area–to-volume ratios and thus retain more heat) to favor open, sun-exposed habitats, while smaller lizards favor shaded habitats. (Heatwole & Taylor 2017; Angilletta et al. 2004).

### **Habitat type and family**

The hypothesis (H2b), that family range, distribution and foraging mode would help explain the correlations between preferred habitat type and lizard families, was not significantly supported. This was perhaps the wrong dataset to extract general family characteristics, traits, and strategies from. Since mMost trait data was given as mean values for a population, then the mean or median of these populations arewould be a poor way to characterize a family’s traits and represent the variation within the family. However, further exportation or use of indices to quantify traits would lead to a higher explanation of inertia. Better family characterizations to include may be more tied to their phenological divergence or continental distributions. 

Alternatively, canonical correspondence analysis is traditionally used in ecology to explain species/family presence by habitat or site characteristics. An additional dataset would be needed to conduct this analysis since further details on habitat characteristics were missing.

Among preferred habitats, it is understandable that sandy (saxicolous) and rocky (psammophilus) habitats are more similar as these species favoring these would have similar adaptations such as longer limbs \[Goodman 2008\]. Since living in water held by plants is very different from the adaptations needed for living on the ground, the negative relationship to bromelicolous habitats is expected. It is curious however, that bromelicolous is closely correlated to fossorial, terrestrial, and aquatic preferred habitats. While adaptations to aquatic habitats would be similar to those for living in the water of plants, such as slim bodies, protruding nostrils, and long, thin fingers \[Jorge 2021,  Carrillo 2022\] these habitats have very different requirements than fossorial traits such as reduced limbs \[Anelli 2024\]. Terrestrial habitats falls closer to the average family distribution likely because it is the dominant and catch-all habitat category. Although similar, semi-arboreal are understandably less distinct than arboreal as this classification is typically used for terrestrial species that have the ability to climb trees, but both would favor adaptations such as large toe pads and lamellae which increase clinging performance \[Wright 2021\].

Most of the family clustering follows evolutionary tree lineages. Teiidae, gymnophthalimidae, and lacertidat all come from the Laceretoidea suborder. Of these three, lacertidae is the most different, which could be explained as it is only found in Eurasia and Africa, while teiidae and gymnophthalimidae are only found in the Americas \[O’Shea 2021\]. Close to this cluster we also observe scincidae, which diverges just before the lacertoidea group and is thus closely related genetically \[O’Shea 2021, Mesquita 2025\]. The Iguania suborder is scattered, but this could be because the suborder and families are very diverse and represented between habitat types \[O’Shea 2021\], thus they are generally near the center. Anoles, the dactyloidae family, is an exception within this suborder that is distinct, perhaps as it evolved more recently \[O’Shea 2021\]. 

The xenosauridae (knob-scaled lizards) is a specialized family and the only representative of suborder anguimorpha which is one of the most derived, thus explaining its strong divergence from the average family. Indeed they are known to inhabit rocky habitats \[O’Shea 2021\] and this relationship is supported by our analysis as well. Likewise, the tropiduridae family is also generally ground dwelling \[O’Shea 2021\] and associated with saxicolous habitat in our dataset. It is unexpected that phyllodactylidae, a family only recently differentiated from gekkonidae \[O’Shea 2021\], is more associated with sandy and rocky habitats than with arboreal habitats. \<anything more of phyllod?\> We do observe that true geckos (gekkonidae) and anoles (dactyloidae) are associated with arboreal and semi-arboreal habitats. These families both demonstrate traits, such as finger pads for climbing that are strongly beneficial for living in trees \[\]. Derived traits are demonstrated in newer lineages and are typically observed for habitat specialist species that have been selected for by specific environmental conditions.

These habitat preferences are also represented in the KNN output as the most distinctive habitats (arboreal and saxicolous) are more easily identified (figure) and terrestrial is just dominant among all families and latitudes. SVL and latitude may be better able to predict family than habitat as family relationships seem to be more defined (especially by geographic range) than habitat preference. As many families are constrained to continents it would also make sense to include longitude for this model.

While the variables selected were poor for explaining these relationships between families and preferred habitats, the correlations observed are generally supported by the literature, suggesting that there are other variables that could explain this relationship. Traits such as claw or leg lengths were not included in this dataset, but may be more telling of habitat preferences. Families often include many genera and even more species, so it may be preferred to examine these relationships at a finer level. This could clarify some of the messiness demonstrated by large families that show large diversity and divergences and are present in many habitat types. Afterall conservation is often done at the species level, rather than by family (however this dataset was limited in the number of species that were observed more than one or two times). Genus relationships may be a happy middle ground where traits and similarity is more common, and some predictive power is useful over just assessing species by species.

# Conclusion

To conclude one can say that these results highlight how strongly the habitat dataset’s extreme class imbalance affects models prediction ability and that SVL and latitude alone provide very limited power for predicting a lizard's preferred habitat type. More variables than just SVL and latitude are needed to accurately predict a lizards preferred habitat that is not terrestrial. Although an annoyance for analysis, the generalist strategy of terrestrial species is likely to make them less susceptible to land-use and climate change compared to their specialized relatives. Overall some highly derived families show strong habitat preferences, but this is not represented by range, percent tropical distribution, or percent active foraging. However correspondence does match the literature, suggesting that better chosen variables can explain this relationship. Therefore, the hypothesis (H1, H2b) can not be supported whereas for H2a a link can be observed. 

Our analysis shows the importance of selecting the good variables to understand and predict relationships. Good variables should be uncorrelated, evenly distributed, balanced, and representative, additionally (or more importantly) capture complex ecological interactions.  This is useful to consider when designing a study and before further field data is collected. Using additional data would allow for the ability to analyze global trends, but is constrained by the variables available. 

Conservation and research of lizards and their habitats will continue to be important as populations are threatened by climate change, habitat loss, and diseases \[Jiang et al, 2023\]. There is great potential of citizen science to propel the conservation of these families and their habitats, but better variables and improved models will need to be realized to fully capture this potential. As citizen science continues to expand global biodiversity datasets, the potential for predictive habitat modelling will grow—but only if we pair these large datasets with balanced sampling, ecologically relevant variables, and models capable of representing the true complexity of lizard–ecosystem interactions.
