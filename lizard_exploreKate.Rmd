---
title: "R Notebook"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Ctrl+Shift+Enter*. 


```{r}
library(FactoMineR) # For PCA
library(factoextra) # For PCA plots
library(tidyverse)
library(corrplot)

library(vegan) # For CCA
library(GGally)
library(ggplot2)
library(ggrepel)
```


```{r}
setwd("~/R/Git/MathComputerTools_Evaluation")

liz = read.csv("lizard.csv", header=T)

head(liz)
unique(liz$Genus)
n_distinct(liz$Genus)
unique(liz$Prefered.Habitat.Type)
unique(liz$Foraging.Mode)
unique(liz$Distribution)

unique(liz$Family)
n_distinct(liz$Family)

```



#remove nas
```{r}
liz.var = liz %>% select (-c(SD.Female.adult.weight..g., Sample.Size.Female.adult.weight, SD.F.SVL.adults..mm., Sample.size.Mean.F.SVL.adults, Sample.size.Clutch.Size., Source ))

#remove nas, but so small shouldn't use just
liz.var = na.omit(liz.var)

head(liz.var)


```

#scale data
```{r}
liz.scaled <- liz.var %>% 
  select_if(is.numeric) %>% #Only numeric columns are selected
  mutate_all(.funs = scale) 
```


#corrplot
```{r}
#must remove nas
liz.scaled %>% # In data_soils
  select_if(is.numeric) %>% # Select only numeric columns
  cor() %>% # Calculate the empirical correlation matrix
  corrplot() # Then graph this matrix
```

```{r}
liz.var =select(liz.var, - Mode.of.reproduction )
ggpairs(liz.var, columns = 7:14)
```



#pca
```{r}
result_pca <- PCA(liz.scaled, 
               scale.unit = TRUE, 
               graph = F)

fviz_pca_var(result_pca,
             axes = c(1, 2), col.var="cos2") # Number of axes to represent 
fviz_pca_var(result_pca,
             axes = c(1, 3), col.var="cos2")
fviz_pca_biplot(result_pca, axes = c(1,2), col.ind=liz.var$Prefered.Habitat.Type)
fviz_pca_biplot(result_pca, axes = c(1,2), col.ind=liz.var$Distribution)
fviz_pca_biplot(result_pca, axes = c(1,2), col.ind=liz.var$Foraging.Mode)
fviz_pca_biplot(result_pca, axes = c(1,2), col.ind=liz.var$Mode.of.reproduction)

fviz_pca_biplot(result_pca, axes = c(1,3), col.ind=liz.var$Prefered.Habitat.Type)
fviz_pca_biplot(result_pca, axes = c(1,3), col.ind=liz.var$Distribution)
fviz_pca_biplot(result_pca, axes = c(1,3), col.ind=liz.var$Foraging.Mode)
fviz_pca_biplot(result_pca, axes = c(1,3), col.ind=liz.var$Mode.of.reproduction)

```


#explore plots
```{r}
ggplot(liz.var, aes(x=Average.Female.adult.weight..g., y=Mean.F.SVL.adults..mm., color= Foraging.Mode))+
  geom_point()
  
ggplot(liz.var, aes(x=Average.Female.adult.weight..g., y=Mean.Clutch.Size, color= Foraging.Mode))+
  geom_point()
ggplot(liz.var, aes(x=Average.Female.adult.weight..g., y=Clutch.Frequency, color= Foraging.Mode))+
  geom_point()
ggplot(liz.var, aes(x=Average.Female.adult.weight..g., y=RCM, color= Foraging.Mode))+
  geom_point()
ggplot(liz.var, aes(x=RCM, y=Mean.Clutch.Size, color= Foraging.Mode))+
  geom_point()

```

```{r}
ggplot(liz.var, aes(x=Average.Female.adult.weight..g., y=Mean.F.SVL.adults..mm., color= Prefered.Habitat.Type))+
  geom_point()
ggplot(liz.var, aes(x=Average.Female.adult.weight..g., y=Mean.Clutch.Size, color= Prefered.Habitat.Type))+
  geom_point()
ggplot(liz.var, aes(x=Average.Female.adult.weight..g., y=Clutch.Frequency, color= Prefered.Habitat.Type))+
  geom_point()
ggplot(liz.var, aes(x=Average.Female.adult.weight..g., y=RCM, color= Prefered.Habitat.Type))+
  geom_point()
ggplot(liz.var, aes(x=RCM, y=Mean.Clutch.Size, color= Prefered.Habitat.Type))+
  geom_point()

```



```{r}
ggplot(liz.var, aes(x=Average.Female.adult.weight..g., y=Mean.F.SVL.adults..mm., color= Mode.of.reproduction))+
  geom_point()
ggplot(liz.var, aes(x=Average.Female.adult.weight..g., y=Mean.Clutch.Size, color= Mode.of.reproduction))+
  geom_point()
ggplot(liz.var, aes(x=Average.Female.adult.weight..g., y=Clutch.Frequency, color= Mode.of.reproduction))+
  geom_point()
ggplot(liz.var, aes(x=Average.Female.adult.weight..g., y=RCM, color= Mode.of.reproduction))+
  geom_point()
ggplot(liz.var, aes(x=RCM, y=Mean.Clutch.Size, color= Mode.of.reproduction))+
  geom_point()

```


```{r}
ggplot(liz.var, aes(x=Average.Female.adult.weight..g., y=Mean.F.SVL.adults..mm., color= Distribution))+
  geom_point()
ggplot(liz.var, aes(x=Average.Female.adult.weight..g., y=Mean.Clutch.Size, color= Distribution))+
  geom_point()
ggplot(liz.var, aes(x=Average.Female.adult.weight..g., y=Clutch.Frequency, color= Distribution))+
  geom_point()
ggplot(liz.var, aes(x=Mean.F.SVL.adults..mm., y=RCM, color= Distribution))+
  geom_point()
ggplot(liz.var, aes(x=RCM, y=Mean.Clutch.Size, color= Distribution))+
  geom_point()

```

```{r}
ggplot(liz.var, aes(x=Average.Female.adult.weight..g., y=Mean.F.SVL.adults..mm., color= Mode.of.reproduction))+
  geom_point()
ggplot(liz.var, aes(x=Average.Female.adult.weight..g., y=Mean.Clutch.Size, color= Mode.of.reproduction))+
  geom_point()
ggplot(liz.var, aes(x=Average.Female.adult.weight..g., y=Clutch.Frequency, color= Mode.of.reproduction))+
  geom_point()
ggplot(liz.var, aes(x=Average.Female.adult.weight..g., y=RCM, color= Mode.of.reproduction))+
  geom_point()
ggplot(liz.var, aes(x=RCM, y=Mean.Clutch.Size, color= Mode.of.reproduction))+
  geom_point()

```


```{r}
ggplot(liz.var, aes(x=abs(Latitude), y=Mean.F.SVL.adults..mm., color= Foraging.Mode))+
  geom_point()
ggplot(liz.var, aes(x=abs(Latitude), y=Mean.Clutch.Size, color= Foraging.Mode))+
  geom_point()
ggplot(liz.var, aes(x=abs(Latitude), y=RCM, color= Foraging.Mode))+
  geom_point()
ggplot(liz.var, aes(x=abs(Latitude), y=Average.Female.adult.weight..g., color= Foraging.Mode))+
  geom_point()+
  ylim(0,100)

```



#CCA
correspondence between habitat type and foraging mode
have to make abundance table
```{r}
liz.2var = select(liz.var, c(Prefered.Habitat.Type, Foraging.Mode))

liz.2var %>%  
  as.matrix() %>% # Data is first transformed into a matrix
  image()
```

#clustering 
kmeans
```{r}
liz.scaled3= liz.scaled %>% select (c( Mean.F.SVL.adults..mm., Mean.Clutch.Size))

kmeans_4groups <- liz.scaled3 %>% 
  select_if(is.numeric) %>% # We only keep numerical columns for kmeans!
  kmeans(centers = 4, nstart = 50 ) 


```

```{r}
clusters_4groups <- kmeans_4groups$cluster

traits_kmeans1 <- liz.var %>% 
  mutate(kmeans_4 = factor(clusters_4groups))

traits_kmeans1 %>% 
  group_by(kmeans_4) %>% 
  # For each group, we count the number of lines
  count()
# Average and standard deviation
traits_kmeans1 %>% 
  group_by(kmeans_4) %>% 
  # For each group, summarise the numerical columns
  # by calculating a list of functions, in this case the mean and standard deviation
  summarise_if(is.numeric, .funs = list(Mean = mean, 
                                        Standard_deviation = sd))

traits_kmeans1 %>% 
  ggplot(aes(x = kmeans_4, y = Average.Female.adult.weight..g.)) + 
  geom_boxplot() + 
  labs(x = "Cluster")
traits_kmeans1 %>% 
  ggplot(aes(x = kmeans_4, y = Latitude)) + 
  geom_boxplot() + 
  labs(x = "Cluster")
traits_kmeans1 %>% 
  ggplot(aes(x = kmeans_4, y = Mean.F.SVL.adults..mm.)) + 
  geom_boxplot() + 
  labs(x = "Cluster")
traits_kmeans1 %>% 
  ggplot(aes(x = kmeans_4, y = Offspring.SVL..mm.)) + 
  geom_boxplot() + 
  labs(x = "Cluster")
traits_kmeans1 %>% 
  ggplot(aes(x = kmeans_4, y = Mean.Clutch.Size)) + 
  geom_boxplot() + 
  labs(x = "Cluster")
traits_kmeans1 %>% 
  ggplot(aes(x = kmeans_4, y = RCM)) + 
  geom_boxplot() + 
  labs(x = "Cluster")


```
*recomend remove 3 outliers


```{r}
traits_kmeans1 <- liz.var %>% 
  mutate(kmeans_4 = factor(clusters_4groups))

ggpairs(traits_kmeans1, 
                mapping = aes(color = kmeans_4),
                columns = 2:6)


```


Is foraging mode and habitat type linked? what is this association linked to?

- cc
How does habitat type effect weight?

Is there a clustering of life history strategies? What characterizes them?





***How do lizard life history traits differ on latitude gradient?***


Can use latitude and body weight to predict svl maturity and svl offspring?



cat
-genus
- family
- reproductive mode
- foraging mode
* distribution
- habitat type


numerical
*- longitude
- latitude
- weight mean
- svl mean
* maturity size/svl
- offspring svl/size
- clutch size
* clutch per year - sparse data
* clutch freq (just 1 or 2 categorical)
- rcm egg ratio


Can we use latitude and svl mean to predict foraging/habitat behavior?
KNN, random forest

Is lizard family and habitat type related? what drives this relationship?
CCA

    -Is lizard habitat type and family linked, what explains? (feeding, lat, weight, svl, )
    (genus (n=138)/ family (34) to habitat)

    ***How do lizard life history traits differ on latitude gradient?***
    
#start here    
```{r}


liz$Latitude = abs(liz$Latitude)
ggplot(liz.fam, aes(x=Mean.F.SVL.adults..mm., y=Latitude, color= Family))+
  geom_point()

ggplot(liz.fam, aes(x=Mean.F.SVL.adults..mm., y=Mean.Clutch.Size, color= Family))+
  geom_point()

countFam =liz %>% 
  group_by(Family) %>%
  count() %>% 
  filter(n>20)
Fam = countFam$Family
liz.fam=filter(liz, Family %in% Fam)

liz %>% 
  group_by(Prefered.Habitat.Type) %>%
  count()
```



##PCA , lat regression
```{r}
liz.var = liz %>% select (c(Latitude, Average.Female.adult.weight..g., Mean.F.SVL.adults..mm., Offspring.SVL..mm., Mean.Clutch.Size, RCM, Family, Prefered.Habitat.Type,Distribution, Foraging.Mode, Mode.of.reproduction))

liz.var = na.omit(liz.var)
#liz.var = filter(liz.var, IndividualID == i)#remove outliers

liz.var$Latitude = abs(liz.var$Latitude)

head(liz.var)
#remove outliers

```

    
```{r}
liz.scaled <- liz.var %>% 
  select (-c(Latitude)) %>% 
  select_if(is.numeric) %>% #Only numeric columns are selected
  mutate_all(.funs = scale) 

liz.scaledLat <- liz.var %>% 
  #select (-c(Latitude)) %>% 
  select_if(is.numeric) %>% #Only numeric columns are selected
  mutate_all(.funs = scale) 
```


#corrplot
```{r}
#must remove nas
liz.scaledLat %>% # In data_soils
  select_if(is.numeric) %>% # Select only numeric columns
  cor() %>% # Calculate the empirical correlation matrix
  corrplot() # Then graph this matrix
```    
    
```{r}
result_pca <- PCA(liz.scaled, 
               scale.unit = TRUE, # Option to center and scale data (useless here)
               ncp = 18, # Number of components to keep (here, all) 18 is max for this dataset
               graph = T)

fviz_pca_var(result_pca,
             axes = c(1, 2), col.var="cos2") # Number of axes to represent 
fviz_pca_var(result_pca,
             axes = c(1, 3), col.var="cos2")
fviz_pca_biplot(result_pca, axes = c(1,2), col.ind=liz.var$Prefered.Habitat.Type)
fviz_pca_biplot(result_pca, axes = c(1,2), col.ind=liz.var$Distribution)
fviz_pca_biplot(result_pca, axes = c(1,2), col.ind=liz.var$Foraging.Mode)
fviz_pca_biplot(result_pca, axes = c(1,2), col.ind=liz.var$Mode.of.reproduction)
```
with lat
```{r}
result_pcaL <- PCA(liz.scaledLat, 
               scale.unit = TRUE, # Option to center and scale data (useless here)
               ncp = 18, # Number of components to keep (here, all) 18 is max for this dataset
               graph = T)

fviz_pca_var(result_pcaL,
             axes = c(1, 2), col.var="cos2") # Number of axes to represent 
fviz_pca_var(result_pcaL,
             axes = c(1, 3), col.var="cos2")
fviz_pca_biplot(result_pcaL, axes = c(1,2), col.ind=liz.var$Prefered.Habitat.Type)
fviz_pca_biplot(result_pcaL, axes = c(1,2), col.ind=liz.var$Distribution)
fviz_pca_biplot(result_pcaL, axes = c(1,2), col.ind=liz.var$Foraging.Mode)
fviz_pca_biplot(result_pcaL, axes = c(1,2), col.ind=liz.var$Mode.of.reproduction)
```

Latitude gradients of lizards
Lat and svl to predict habitat
  any better with more variables



```{r}
fviz_eig(result_pca, choice = "variance")
result_pca$var$contrib
```
  
```{r}
result_pca$ind$coord

pcavar = get_pca_ind(result_pca)

liz.var.pca = cbind(liz.var, pcavar$coord)
```
 
 
 
  
  
  regression
```{r}
modelH = glm(Prefered.Habitat.Type ~ Dim.1, data = liz.var.pca)
summary(modelH)

#model2 = lm(Latitude ~ Dim.2, data = liz.var.pca)
#summary(model2)

ggplot(liz.var.pca, aes(x=Latitude, y = Dim.1, color= Family))+
  geom_point()



ggplot(liz.var.pca, aes(x=Latitude, y = Dim.2))+
  geom_point()+
  geom_smooth(method=lm)
```

  
```{r}
pcaT = filter(liz.var.pca, Family == "Teiidae")
pcaS = filter(liz.var.pca, Family == "Scincidae")

ggplot(pcaT, aes(x=Latitude, y = Dim.2))+
  geom_point()+
  geom_smooth(method=lm)
ggplot(pcaS, aes(x=Latitude, y = Dim.2))+
  geom_point()+
  geom_smooth(method=lm)
```

 
 
 
 
##pca arboreal vs Saxicolous
```{r}
liz.varSA = liz.var %>%
  filter(Prefered.Habitat.Type == "Saxicolous" |Prefered.Habitat.Type == "Arboreal" )

lizSA.scaled <- liz.varSA %>% 
  select (-c(Latitude)) %>% 
  select_if(is.numeric) %>% #Only numeric columns are selected
  mutate_all(.funs = scale)

#separate data set before or after PCA???


```


```{r}
result_pcaSA <- PCA(lizSA.scaled, 
               scale.unit = TRUE, # Option to center and scale data (useless here)
               ncp = 18, # Number of components to keep (here, all) 18 is max for this dataset
               graph = T)
fviz_pca_biplot(result_pcaSA, axes = c(1,2), col.ind=liz.varSA$Prefered.Habitat.Type)

fviz_pca_biplot(result_pcaSA, axes = c(2,3), col.ind=liz.varSA$Prefered.Habitat.Type)

fviz_eig(result_pcaSA, choice = "variance")
result_pcaSA$var$contrib
```  
    
    
    
```{r}
#result_pcaSA$ind$coord

pcavarSA = get_pca_ind(result_pcaSA)

liz.var.pcaSA = cbind(liz.varSA, pcavarSA$coord)
```
    
    
```{r}
ggplot(liz.var.pca, aes(x=Latitude, y = Dim.1))+
  geom_point()+
  geom_smooth(method=lm)
```
    actually use original pca results then compare 2 trends
    
    
    

##CCA
#data set up
```{r}

aliz=liz %>%
  group_by(Prefered.Habitat.Type, Family) %>%
  summarise(n=n()) %>% 
  filter(Prefered.Habitat.Type != "")

mliz = aliz %>% 
  pivot_wider(names_from = "Prefered.Habitat.Type", values_from = n) %>% 
  replace(is.na(.), 0) 

mlizsm = mliz %>% filter( Family %in% Fam)%>% 
  column_to_rownames("Family")
#aliz <- aliz %>% mutate_at(2:9, as.integer)

aliz

```

heat map
```{r}
mliz %>%  
  as.matrix() %>% # Data is first transformed into a matrix
  image() # Summary representation


```

heatmap ggplot
```{r}
ggplot(aliz) +
  aes(x = Prefered.Habitat.Type, y = Family, fill = n) + # fill says which column is used 
  # for filling
  geom_raster() + # represents in raster mode
  # and dress to make it pretty
  scale_fill_viridis_c() + # Change color scale
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```
? balloon plot
```{r}
balloonplot(t(dt), main ="mliz", xlab ="", ylab="",
            label = FALSE, show.margins = FALSE)
```



#compare profiles
```{r}
average_profile <- colSums(mliz) / sum(mliz)
average_profile

counts_sols <- rowSums(mliz)
counts_sols

# Division by counts
species_repartition <- (mliz / counts_sols) %>% 
  rbind(Average_profile = average_profile) # Adding average profile
species_repartition
```

plot above by columns?

```{r}
liz.var = liz %>% select (c(Family, Latitude, Mean.F.SVL.adults..mm., Mean.Clutch.Size, Foraging.Mode, Mode.of.reproduction ))

#remove nas, but so small shouldn't use just
liz.var = na.omit(liz.var)

head(liz.var)
```



#cv major families
```{r}
result_CA <- CA(mliz, graph = T)
fviz_eig(result_CA)
fviz_ca_biplot(result_CA, repel = TRUE)

result_CAsm <- CA(mlizsm, graph = T)
fviz_eig(result_CAsm)
fviz_ca_biplot(result_CAsm, repel = TRUE)
```

#data for cca

```{r}
liz$Latitude = abs(liz$Latitude)
#set Active foraging to 1 and Sit&Wait to 0; set Tropical distribution to 1 and Temperate to 0 (to calculate proportion)
liz = liz %>% 
  mutate(ForageActive = if_else(Foraging.Mode == "Active", 1, 0)) 
liz = liz %>% 
  mutate(DistTropic = if_else(Distribution == "Tropical", 1, 0)) 

#variables for families
#justify using these variables
fam.var = liz %>%
  filter( Family %in% Fam) %>% 
  group_by(Family) %>%
  summarise(n=n(), minLat= min(Latitude), maxLat = max(Latitude), pctActive= sum(ForageActive)/n(), pctTropic= sum(DistTropic)/n())
```

#don't know how to visualize...
```{r}
ggplot(fam.var, aes())+
  geom_point()+
  facet_grid(Family ~, scales = "free_y")+
```


```{r}
#run CCA
CCAresult = cca(mlizsm ~ minLat + maxLat + pctActive + pctTropic, data = fam.var)

CCAscores = scores(CCAresult)
CCAtable = CCAresult$CCA$u
CCAcorr = cor(CCAtable, fam.var[, c("minLat", "maxLat", "pctActive", "pctTropic")])


CCAscores_species = as.data.frame(CCAscores$species) %>% 
  rownames_to_column(var = "Habitat")
CCAscores_sites = as.data.frame(CCAscores$sites) %>% 
  rownames_to_column(var = "Family")
CCAscores_var = as.data.frame(CCAscores$biplot) %>% 
  mutate_all(function(x)x*ordiArrowMul(CCAscores$biplot)) %>%
  rownames_to_column(var = "Covariable")

```

```{r}
#I think can get CA results from CCA run
#result_pca$var$contrib
summary(CCAresult)


```

```{r}
#plot results
plot(CCAresult)
corrplot(CCAcorr)

fviz_eig(CCAresult)
screeplot(CCAresult, bstick = TRUE, type = c("lines"))

ggplot(CCAscores_sites)+
  aes(x =CCA1, y=CCA2)+
  geom_hline(linetype=2, yintercept = 0)+
  geom_vline(linetype=2, xintercept = 0)+
  #geom_point(aes(color=Family))+
  geom_point(data=CCAscores_species, color ="red")+
  geom_text_repel(data = CCAscores_species, aes(label = Habitat), color= "red")+
  geom_text_repel(data = CCAscores_var, aes(label = Covariable), color="black")+
  geom_segment(data= CCAscores_var, aes(xend = CCA1, yend = CCA2), x =0, y=0, color = "black", arrow = arrow(length = unit(0.1, "cm")))+
  geom_point(data=CCAscores_sites, color ="blue")+
  geom_text_repel(data = CCAscores_sites, aes(label = Family), color= "blue")+
  theme_bw()
  
  
```


```{r}
CCAresult$CA

```


```{r}
#statistical test
anova(CCAresult)
anova(CCAresult,by="margin")
```








