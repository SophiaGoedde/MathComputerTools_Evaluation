---
title: "R Notebook"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Ctrl+Shift+Enter*. 


```{r}
library(FactoMineR) # For PCA
library(factoextra) # For PCA plots
library(tidyverse)
library(corrplot)

library(vegan) # For CCA
library(GGally)
library(ggplot2)
```


```{r}
setwd("~/R/Git/MathComputerTools_Evaluation")

liz = read.csv("lizard.csv", header=T)

head(liz)
unique(liz$Genus)
n_distinct(liz$Genus)
unique(liz$Prefered.Habitat.Type)
unique(liz$Foraging.Mode)
unique(liz$Distribution)

unique(liz$Family)
n_distinct(liz$Family)

```



#remove nas
```{r}
liz.var = liz %>% select (-c(SD.Female.adult.weight..g., Sample.Size.Female.adult.weight, SD.F.SVL.adults..mm., Sample.size.Mean.F.SVL.adults, Sample.size.Clutch.Size., Source ))

#remove nas, but so small shouldn't use just
liz.var = na.omit(liz.var)

head(liz.var)


```

#scale data
```{r}
liz.scaled <- liz.var %>% 
  select_if(is.numeric) %>% #Only numeric columns are selected
  mutate_all(.funs = scale) 
```


#corrplot
```{r}
#must remove nas
liz.scaled %>% # In data_soils
  select_if(is.numeric) %>% # Select only numeric columns
  cor() %>% # Calculate the empirical correlation matrix
  corrplot() # Then graph this matrix
```

```{r}
liz.var =select(liz.var, - Mode.of.reproduction )
ggpairs(liz.var, columns = 7:14)
```



#pca
```{r}
result_pca <- PCA(liz.scaled, 
               scale.unit = TRUE, # Option to center and scale data (useless here)
               ncp = 18, # Number of components to keep (here, all) 18 is max for this dataset
               graph = T)

fviz_pca_var(result_pca,
             axes = c(1, 2), col.var="cos2") # Number of axes to represent 
fviz_pca_var(result_pca,
             axes = c(1, 3), col.var="cos2")
fviz_pca_biplot(result_pca, axes = c(1,2), col.ind=liz.var$Prefered.Habitat.Type)
fviz_pca_biplot(result_pca, axes = c(1,2), col.ind=liz.var$Distribution)
fviz_pca_biplot(result_pca, axes = c(1,2), col.ind=liz.var$Foraging.Mode)
fviz_pca_biplot(result_pca, axes = c(1,2), col.ind=liz.var$Mode.of.reproduction)

fviz_pca_biplot(result_pca, axes = c(1,3), col.ind=liz.var$Prefered.Habitat.Type)
fviz_pca_biplot(result_pca, axes = c(1,3), col.ind=liz.var$Distribution)
fviz_pca_biplot(result_pca, axes = c(1,3), col.ind=liz.var$Foraging.Mode)
fviz_pca_biplot(result_pca, axes = c(1,3), col.ind=liz.var$Mode.of.reproduction)

```


#explore plots
```{r}
ggplot(liz.var, aes(x=Average.Female.adult.weight..g., y=Mean.F.SVL.adults..mm., color= Foraging.Mode))+
  geom_point()
  
ggplot(liz.var, aes(x=Average.Female.adult.weight..g., y=Mean.Clutch.Size, color= Foraging.Mode))+
  geom_point()
ggplot(liz.var, aes(x=Average.Female.adult.weight..g., y=Clutch.Frequency, color= Foraging.Mode))+
  geom_point()
ggplot(liz.var, aes(x=Average.Female.adult.weight..g., y=RCM, color= Foraging.Mode))+
  geom_point()
ggplot(liz.var, aes(x=RCM, y=Mean.Clutch.Size, color= Foraging.Mode))+
  geom_point()

```

```{r}
ggplot(liz.var, aes(x=Average.Female.adult.weight..g., y=Mean.F.SVL.adults..mm., color= Prefered.Habitat.Type))+
  geom_point()
ggplot(liz.var, aes(x=Average.Female.adult.weight..g., y=Mean.Clutch.Size, color= Prefered.Habitat.Type))+
  geom_point()
ggplot(liz.var, aes(x=Average.Female.adult.weight..g., y=Clutch.Frequency, color= Prefered.Habitat.Type))+
  geom_point()
ggplot(liz.var, aes(x=Average.Female.adult.weight..g., y=RCM, color= Prefered.Habitat.Type))+
  geom_point()
ggplot(liz.var, aes(x=RCM, y=Mean.Clutch.Size, color= Prefered.Habitat.Type))+
  geom_point()

```



```{r}
ggplot(liz.var, aes(x=Average.Female.adult.weight..g., y=Mean.F.SVL.adults..mm., color= Mode.of.reproduction))+
  geom_point()
ggplot(liz.var, aes(x=Average.Female.adult.weight..g., y=Mean.Clutch.Size, color= Mode.of.reproduction))+
  geom_point()
ggplot(liz.var, aes(x=Average.Female.adult.weight..g., y=Clutch.Frequency, color= Mode.of.reproduction))+
  geom_point()
ggplot(liz.var, aes(x=Average.Female.adult.weight..g., y=RCM, color= Mode.of.reproduction))+
  geom_point()
ggplot(liz.var, aes(x=RCM, y=Mean.Clutch.Size, color= Mode.of.reproduction))+
  geom_point()

```


```{r}
ggplot(liz.var, aes(x=Average.Female.adult.weight..g., y=Mean.F.SVL.adults..mm., color= Distribution))+
  geom_point()
ggplot(liz.var, aes(x=Average.Female.adult.weight..g., y=Mean.Clutch.Size, color= Distribution))+
  geom_point()
ggplot(liz.var, aes(x=Average.Female.adult.weight..g., y=Clutch.Frequency, color= Distribution))+
  geom_point()
ggplot(liz.var, aes(x=Mean.F.SVL.adults..mm., y=RCM, color= Distribution))+
  geom_point()
ggplot(liz.var, aes(x=RCM, y=Mean.Clutch.Size, color= Distribution))+
  geom_point()

```

```{r}
ggplot(liz.var, aes(x=Average.Female.adult.weight..g., y=Mean.F.SVL.adults..mm., color= Mode.of.reproduction))+
  geom_point()
ggplot(liz.var, aes(x=Average.Female.adult.weight..g., y=Mean.Clutch.Size, color= Mode.of.reproduction))+
  geom_point()
ggplot(liz.var, aes(x=Average.Female.adult.weight..g., y=Clutch.Frequency, color= Mode.of.reproduction))+
  geom_point()
ggplot(liz.var, aes(x=Average.Female.adult.weight..g., y=RCM, color= Mode.of.reproduction))+
  geom_point()
ggplot(liz.var, aes(x=RCM, y=Mean.Clutch.Size, color= Mode.of.reproduction))+
  geom_point()

```


```{r}
ggplot(liz.var, aes(x=abs(Latitude), y=Mean.F.SVL.adults..mm., color= Foraging.Mode))+
  geom_point()
ggplot(liz.var, aes(x=abs(Latitude), y=Mean.Clutch.Size, color= Foraging.Mode))+
  geom_point()
ggplot(liz.var, aes(x=abs(Latitude), y=RCM, color= Foraging.Mode))+
  geom_point()
ggplot(liz.var, aes(x=abs(Latitude), y=Average.Female.adult.weight..g., color= Foraging.Mode))+
  geom_point()+
  ylim(0,100)

```



#CCA
correspondence between habitat type and foraging mode
have to make abundance table
```{r}
liz.2var = select(liz.var, c(Prefered.Habitat.Type, Foraging.Mode))

liz.2var %>%  
  as.matrix() %>% # Data is first transformed into a matrix
  image()
```

#clustering 
kmeans
```{r}

kmeans_4groups <- liz.scaled %>% 
  select_if(is.numeric) %>% # We only keep numerical columns for kmeans!
  kmeans(centers = 4, nstart = 50 ) 


```

```{r}
clusters_4groups <- kmeans_4groups$cluster

traits_kmeans1 <- liz.var %>% 
  mutate(kmeans_4 = factor(clusters_4groups))

traits_kmeans %>% 
  group_by(kmeans_4) %>% 
  # For each group, we count the number of lines
  count()
# Average and standard deviation
traits_kmeans %>% 
  group_by(kmeans_4) %>% 
  # For each group, summarise the numerical columns
  # by calculating a list of functions, in this case the mean and standard deviation
  summarise_if(is.numeric, .funs = list(Mean = mean, 
                                        Standard_deviation = sd))

traits_kmeans %>% 
  ggplot(aes(x = kmeans_4, y = Average.Female.adult.weight..g.)) + 
  geom_boxplot() + 
  labs(x = "Cluster")
traits_kmeans %>% 
  ggplot(aes(x = kmeans_4, y = Mean.F.SVL.adults..mm.)) + 
  geom_boxplot() + 
  labs(x = "Cluster")
traits_kmeans %>% 
  ggplot(aes(x = kmeans_4, y = Offspring.SVL..mm.)) + 
  geom_boxplot() + 
  labs(x = "Cluster")
traits_kmeans %>% 
  ggplot(aes(x = kmeans_4, y = Mean.Clutch.Size)) + 
  geom_boxplot() + 
  labs(x = "Cluster")
traits_kmeans %>% 
  ggplot(aes(x = kmeans_4, y = RCM)) + 
  geom_boxplot() + 
  labs(x = "Cluster")


```

```{r}
traits_kmeans1 <- liz.var %>% 
  mutate(kmeans_4 = factor(clusters_4groups))

ggpairs(traits_kmeans1, 
                mapping = aes(color = kmeans_4),
                columns = 2:6)


```


Is foraging mode and habitat type linked? what is this association linked to?

- cc
How does habitat type effect weight?

Is there a clustering of life history strategies? What characterizes them?





***How do lizard life history traits differ on latitude gradient?***


Can use latitude and body weight to predict svl maturity and svl offspring?



cat
-genus
- family
- reproductive mode
- foraging mode
* distribution
- habitat type


numerical
*- longitude
- latitude
- weight mean
- svl mean
* maturity size/svl
- offspring svl/size
- clutch size
* clutch per year - sparse data
* clutch freq (just 1 or 2 categorical)
- rcm egg ratio


Can we use latitude and svl mean to predict foraging/habitat behavior?
KNN, random forest

Is lizard family and habitat type related? what drives this relationship?
CCA

    -Is lizard habitat type and family linked, what explains? (feeding, lat, weight, svl, )
    (genus (n=138)/ family (34) to habitat)

    ***How do lizard life history traits differ on latitude gradient?***
    
#start here    
##PCA , lat regression
```{r}
liz.var = liz %>% select (c(Latitude, Average.Female.adult.weight..g., Mean.F.SVL.adults..mm., Offspring.SVL..mm., Mean.Clutch.Size, RCM, Prefered.Habitat.Type,Distribution, Foraging.Mode, Mode.of.reproduction))

liz.var = na.omit(liz.var)

liz.var$Latitude = abs(liz.var$Latitude)

head(liz.var)
```

    
```{r}
liz.scaled <- liz.var %>% 
  select (-c(Latitude)) %>% 
  select_if(is.numeric) %>% #Only numeric columns are selected
  mutate_all(.funs = scale) 
```


#corrplot
```{r}
#must remove nas
liz.scaled %>% # In data_soils
  select_if(is.numeric) %>% # Select only numeric columns
  cor() %>% # Calculate the empirical correlation matrix
  corrplot() # Then graph this matrix
```    
    
```{r}
result_pca <- PCA(liz.scaled, 
               scale.unit = TRUE, # Option to center and scale data (useless here)
               ncp = 18, # Number of components to keep (here, all) 18 is max for this dataset
               graph = T)

fviz_pca_var(result_pca,
             axes = c(1, 2), col.var="cos2") # Number of axes to represent 
fviz_pca_var(result_pca,
             axes = c(1, 3), col.var="cos2")
fviz_pca_biplot(result_pca, axes = c(1,2), col.ind=liz.var$Prefered.Habitat.Type)
fviz_pca_biplot(result_pca, axes = c(1,2), col.ind=liz.var$Distribution)
fviz_pca_biplot(result_pca, axes = c(1,2), col.ind=liz.var$Foraging.Mode)
fviz_pca_biplot(result_pca, axes = c(1,2), col.ind=liz.var$Mode.of.reproduction)
```
```{r}
fviz_eig(result_pca, choice = "variance")
result_pca$var$contrib
```
  
```{r}
result_pca$ind$coord

pcavar = get_pca_ind(result_pca)

liz.var.pca = cbind(liz.var, pcavar$coord)
```
  
  
  regression
```{r}
model1 = lm(Latitude ~ Dim.1+ Dim.2, data = liz.var.pca)
summary(model1)

#model2 = lm(Latitude ~ Dim.2, data = liz.var.pca)
#summary(model2)

ggplot(liz.var.pca, aes(x=Latitude, y = Dim.1))+
  geom_point()+
  geom_smooth(method = lm)
ggplot(liz.var.pca, aes(x=Latitude, y = Dim.2))+
  geom_point()+
  geom_smooth(method=lm)
```

  
  
    
    

##CCA
#data set up
```{r}

aliz=liz %>%
  group_by(Prefered.Habitat.Type, Family) %>%
  summarise(n=n()) %>% 
  filter(Prefered.Habitat.Type != "")

mliz = aliz %>% 
  pivot_wider(names_from = "Prefered.Habitat.Type", values_from = n) %>% 
  replace(is.na(.), 0) %>% 
  column_to_rownames("Family")

#aliz <- aliz %>% mutate_at(2:9, as.integer)

aliz

```

heat map
```{r}
mliz %>%  
  as.matrix() %>% # Data is first transformed into a matrix
  image() # Summary representation
```

heatmap ggplot
```{r}
ggplot(aliz) +
  aes(x = Prefered.Habitat.Type, y = Family, fill = n) + # fill says which column is used 
  # for filling
  geom_raster() + # represents in raster mode
  # and dress to make it pretty
  scale_fill_viridis_c() + # Change color scale
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```
? balloon plot
```{r}
balloonplot(t(dt), main ="mliz", xlab ="", ylab="",
            label = FALSE, show.margins = FALSE)
```



#compare profiles
```{r}
average_profile <- colSums(mliz) / sum(mliz)
average_profile

counts_sols <- rowSums(mliz)
counts_sols

# Division by counts
species_repartition <- (mliz / counts_sols) %>% 
  rbind(Average_profile = average_profile) # Adding average profile
species_repartition
```

plot above by columns?

```{r}
liz.var = liz %>% select (c(Family, Latitude, Mean.F.SVL.adults..mm., Mean.Clutch.Size, Foraging.Mode, Mode.of.reproduction ))

#remove nas, but so small shouldn't use just
liz.var = na.omit(liz.var)

head(liz.var)
```



#cv
```{r}
result_CA <- CA(mliz, graph = FALSE)
fviz_eig(result_CA)
fviz_ca_biplot(result_CA, repel = TRUE)

```



